<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <base target="_top" />
  <title>Gesti√≥n de D√≠as de Asuntos Particulares Docentes</title>
  <?!= HtmlService.createHtmlOutputFromFile('css').getContent(); ?>
  
</head>
<body>
<?!= incluir('Encabezado'); ?>

  <div id="contenido">
    <div class="marco-blanco" id="app">Cargando...</div>
    
  </div>

  <script>
    google.script.run.withSuccessHandler(mostrarTodo).esDireccion();

    let esDireccionGlobal = false;

    function mostrarTodo(esDireccion) {
      esDireccionGlobal = esDireccion;
      document.getElementById('app').innerHTML = `
        <div class="seccion" id="formularioSeccion"></div>
        <div class="seccion" id="pendientesSeccion">
          <h3>Solicitudes Pendientes</h3>
           <div id="mensajeEstado" style="font-weight: bold; margin-bottom: 10px;"></div>
          <div id="tabla">Cargando...</div>
        </div>
        <div class="seccion" id="misSolicitudesSeccion">
          <h3>Mis Solicitudes</h3>
          <div id="listaMisSolicitudes">Cargando...</div>
        </div>
      `;
      mostrarFormulario();
      cargarSolicitudes(esDireccion);
      cargarMisSolicitudes();
    }

    function mostrarFormulario() {
      document.getElementById('formularioSeccion').innerHTML = `
        <h2>Solicitar d√≠a de asuntos particulares</h2>
        <div id="nombreUsuario" style="margin-bottom: 10px; font-weight: bold;"></div>
        <form id="formularioSolicitud" novalidate>
          <label>Fecha solicitada:
            <input type="date" name="fechaSolicitada" required>
          </label>
          <label>Comentarios (opcional):
            <textarea name="comentario" rows="3" placeholder="Escribe aqu√≠ tus comentarios..."></textarea>
          </label>
          <button type="submit">Enviar solicitud</button>
        </form>
        <div id="diasAprobados" style="margin-top: 10px; font-weight: bold;"></div>
        <div id="mensaje"></div>
      `;

      google.script.run.withSuccessHandler(nombre => {
        document.getElementById('nombreUsuario').textContent = 'üë§ Usuario: ' + nombre;
      }).obtenerNombreUsuario();

      google.script.run.withSuccessHandler(email => {
        google.script.run.withSuccessHandler(total => {
          document.getElementById('diasAprobados').textContent =
            `Tienes ${total} d√≠a(s) de asuntos particulares ya aprobados.`;
        }).contarDiasAprobados(email);
      }).obtenerEmailUsuario();

      document.getElementById('formularioSolicitud').addEventListener('submit', function(e) {
        e.preventDefault();
        const datos = new FormData(this);
        const fecha = datos.get('fechaSolicitada');
        const comentario = datos.get('comentario');
        const mensaje = document.getElementById('mensaje');
        mensaje.textContent = '';
        mensaje.className = '';

        if (!fecha) {
          mensaje.textContent = '‚ùå Debes seleccionar una fecha.';
          mensaje.className = 'error';
          return;
        }

        google.script.run.withSuccessHandler(nombreUsuario => {
          google.script.run.withSuccessHandler(() => {
            mensaje.textContent = '‚úÖ Solicitud enviada correctamente.';
            mensaje.className = 'exito';
            document.getElementById('formularioSolicitud').reset();
            cargarSolicitudes(esDireccionGlobal);
            cargarMisSolicitudes();
          }).withFailureHandler(err => {
            mensaje.textContent = '‚ùå ' + (err.message || 'Error desconocido');
            mensaje.className = 'error';
          }).enviarSolicitud(fecha, comentario, nombreUsuario);
        }).obtenerNombreUsuario();
      });
    }

    function cargarMisSolicitudes() {
      google.script.run.withSuccessHandler(misSolicitudes => {
        const contenedor = document.getElementById("listaMisSolicitudes");
        if (!misSolicitudes || misSolicitudes.length === 0) {
          contenedor.innerHTML = "<p>No has realizado ninguna solicitud.</p>";
          return;
        }

        contenedor.innerHTML = misSolicitudes.map(s => `
          <div style="margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #ccc;">
            <p><strong>${s.fechaSolicitada}</strong> - <em>${s.estado}</em></p>
            <p><strong>Comentario:</strong> ${s.comentario || 'Ninguno'}</p>
            <p><strong>Curso:</strong> ${s.anoEscolar || 'No especificado'}</p>
            <p><small>Enviado: ${s.marcaTiempo}</small></p>
          </div>
        `).join("");
      }).obtenerMisSolicitudes();
    }

    function cargarSolicitudes(esDireccion) {
      google.script.run.withSuccessHandler(solicitudes => {
        mostrarSolicitudes(solicitudes, esDireccion);
      }).obtenerSolicitudesPendientes();
    }

    function mostrarSolicitudes(solicitudes, esDireccion) {
      const contenedor = document.getElementById('tabla');
      if (!solicitudes || solicitudes.length === 0) {
        contenedor.innerHTML = '<p>No hay solicitudes pendientes.</p>';
        return;
      }

      let html = `
        <table>
          <thead>
            <tr>
              <th>Fecha y Hora Solicitud</th>
              <th>Usuario</th>
              <th>Fecha solicitada</th>
              <th>Estado</th>
              <th>Comentario</th>
              <th>A√±o escolar</th>
              <th>Email</th>
              <th>D√≠as aprobados</th>
              ${esDireccion ? '<th>Acciones</th>' : ''}
            </tr>
          </thead>
          <tbody>
      `;

      solicitudes.forEach((s, idx) => {
        const idFila = `fila-${idx}`;
        html += `
          <tr id="${idFila}">
            <td>${s.marcaTiempo || ''}</td>
            <td>${s.usuario || ''}</td>
            <td>${s.fechaSolicitada || ''}</td>
            <td>${s.estado || ''}</td>
            <td>${s.comentario || ''}</td>
            <td>${s.anoEscolar || ''}</td>
            <td>${s.email || ''}</td>
            <td id="dias-${idx}">Cargando...</td>
            ${esDireccion ? `
              <td>
                <button class="btn-aprobar" onclick="actualizarEstado(${s.fila}, 'Aprobado')">Aprobar</button>
                <button class="btn-denegar" onclick="actualizarEstado(${s.fila}, 'Denegado')">Denegar</button>
              </td>` : ''}
          </tr>
        `;

        google.script.run.withSuccessHandler(total => {
          const celda = document.getElementById(`dias-${idx}`);
          if (celda) celda.innerText = total;
        }).contarDiasAprobados(s.email);
      });

      html += `</tbody></table>`;
      contenedor.innerHTML = html;
    }


    function actualizarEstado(fila, nuevoEstado) {
  google.script.run
    .withSuccessHandler(() => {
      const mensaje = document.getElementById("mensajeEstado");
      mensaje.textContent = `‚úÖ Solicitud ${nuevoEstado.toLowerCase()} correctamente.`;
      mensaje.style.color = "green";

      cargarSolicitudes(esDireccionGlobal);
      cargarMisSolicitudes();

      setTimeout(() => {
        mensaje.textContent = "";
      }, 3000);
    })
    .withFailureHandler(err => {
      const mensaje = document.getElementById("mensajeEstado");
      mensaje.textContent = `‚ùå Error al actualizar: ${err.message || err}`;
      mensaje.style.color = "red";

      setTimeout(() => {
        mensaje.textContent = "";
      }, 4000);
    })
    .actualizarEstado(fila, nuevoEstado);
}

  </script>
</body>
</html>
